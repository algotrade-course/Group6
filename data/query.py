daily_data_query = """
WITH date_ranges AS (
    SELECT 'VN30F2101' AS tickersymbol, '2021-01-04'::DATE AS start_date, '2021-01-14'::DATE AS end_date UNION ALL
    SELECT 'VN30F2102', '2021-01-15'::DATE, '2021-02-18'::DATE UNION ALL
    SELECT 'VN30F2103', '2021-02-19'::DATE, '2021-03-18'::DATE UNION ALL
    SELECT 'VN30F2104', '2021-03-19'::DATE, '2021-04-15'::DATE UNION ALL
    SELECT 'VN30F2105', '2021-04-16'::DATE, '2021-05-20'::DATE UNION ALL
    SELECT 'VN30F2106', '2021-05-21'::DATE, '2021-06-17'::DATE UNION ALL
    SELECT 'VN30F2107', '2021-06-18'::DATE, '2021-07-15'::DATE UNION ALL
    SELECT 'VN30F2108', '2021-07-16'::DATE, '2021-08-19'::DATE UNION ALL
    SELECT 'VN30F2109', '2021-08-20'::DATE, '2021-09-16'::DATE UNION ALL
    SELECT 'VN30F2110', '2021-09-17'::DATE, '2021-10-21'::DATE UNION ALL
    SELECT 'VN30F2111', '2021-10-22'::DATE, '2021-11-18'::DATE UNION ALL
    SELECT 'VN30F2112', '2021-11-19'::DATE, '2021-12-16'::DATE UNION ALL
    SELECT 'VN30F2201', '2021-12-17'::DATE, '2022-01-20'::DATE UNION ALL
    SELECT 'VN30F2202', '2022-01-21'::DATE, '2022-02-17'::DATE UNION ALL
    SELECT 'VN30F2203', '2022-02-18'::DATE, '2022-03-17'::DATE UNION ALL
    SELECT 'VN30F2204', '2022-03-18'::DATE, '2022-04-21'::DATE UNION ALL
    SELECT 'VN30F2205', '2022-04-22'::DATE, '2022-05-19'::DATE UNION ALL
    SELECT 'VN30F2206', '2022-05-20'::DATE, '2022-06-16'::DATE UNION ALL
    SELECT 'VN30F2207', '2022-06-17'::DATE, '2022-07-21'::DATE UNION ALL
    SELECT 'VN30F2208', '2022-07-22'::DATE, '2022-08-18'::DATE UNION ALL
    SELECT 'VN30F2209', '2022-08-19'::DATE, '2022-09-15'::DATE UNION ALL
    SELECT 'VN30F2210', '2022-09-16'::DATE, '2022-10-20'::DATE UNION ALL
    SELECT 'VN30F2211', '2022-10-21'::DATE, '2022-11-17'::DATE UNION ALL
    SELECT 'VN30F2212', '2022-11-18'::DATE, '2022-12-15'::DATE UNION ALL
    SELECT 'VN30F2301', '2022-12-16'::DATE, '2023-01-19'::DATE UNION ALL
    SELECT 'VN30F2302', '2023-01-20'::DATE, '2023-02-16'::DATE UNION ALL
    SELECT 'VN30F2303', '2023-02-17'::DATE, '2023-03-16'::DATE UNION ALL
    SELECT 'VN30F2304', '2023-03-17'::DATE, '2023-04-20'::DATE UNION ALL
    SELECT 'VN30F2305', '2023-04-21'::DATE, '2023-05-18'::DATE UNION ALL
    SELECT 'VN30F2306', '2023-05-19'::DATE, '2023-06-15'::DATE UNION ALL
    SELECT 'VN30F2307', '2023-06-16'::DATE, '2023-07-20'::DATE UNION ALL
    SELECT 'VN30F2308', '2023-07-21'::DATE, '2023-08-17'::DATE UNION ALL
    SELECT 'VN30F2309', '2023-08-18'::DATE, '2023-09-21'::DATE UNION ALL
    SELECT 'VN30F2310', '2023-09-22'::DATE, '2023-10-19'::DATE UNION ALL
    SELECT 'VN30F2311', '2023-10-20'::DATE, '2023-11-16'::DATE UNION ALL
    SELECT 'VN30F2312', '2023-11-17'::DATE, '2023-12-21'::DATE UNION ALL
    SELECT 'VN30F2401', '2023-12-22'::DATE, '2024-01-18'::DATE UNION ALL
    SELECT 'VN30F2402', '2024-01-19'::DATE, '2024-02-15'::DATE UNION ALL
    SELECT 'VN30F2403', '2024-02-16'::DATE, '2024-03-21'::DATE UNION ALL
    SELECT 'VN30F2404', '2024-03-22'::DATE, '2024-04-18'::DATE UNION ALL
    SELECT 'VN30F2405', '2024-04-19'::DATE, '2024-05-16'::DATE UNION ALL
    SELECT 'VN30F2406', '2024-05-17'::DATE, '2024-06-20'::DATE UNION ALL
    SELECT 'VN30F2407', '2024-06-21'::DATE, '2024-07-18'::DATE UNION ALL
    SELECT 'VN30F2408', '2024-07-19'::DATE, '2024-08-15'::DATE UNION ALL
    SELECT 'VN30F2409', '2024-08-16'::DATE, '2024-09-19'::DATE UNION ALL
    SELECT 'VN30F2410', '2024-09-20'::DATE, '2024-10-17'::DATE UNION ALL
    SELECT 'VN30F2411', '2024-10-18'::DATE, '2024-11-21'::DATE UNION ALL
    SELECT 'VN30F2412', '2024-11-22'::DATE, '2024-12-19'::DATE UNION ALL
    SELECT 'VN30F2501', '2024-12-20'::DATE, '2025-01-16'::DATE UNION ALL
    SELECT 'VN30F2502', '2025-01-17'::DATE, '2025-02-20'::DATE UNION ALL
    SELECT 'VN30F2503', '2025-02-21'::DATE, '2025-03-20'::DATE
)
SELECT 
    tb_max.datetime, 
    tb_max.tickersymbol AS symbol,
    tb_max.price AS max,
    tb_min.price AS min,
    tb_close.price AS close,
    tb_open.price AS open
FROM quote.max tb_max
JOIN quote.min tb_min 
    ON tb_max.tickersymbol = tb_min.tickersymbol 
    AND tb_max.datetime = tb_min.datetime
JOIN quote.close tb_close 
    ON tb_min.tickersymbol = tb_close.tickersymbol 
    AND tb_min.datetime = tb_close.datetime
JOIN quote.open tb_open 
    ON tb_open.tickersymbol = tb_close.tickersymbol 
    AND tb_open.datetime = tb_close.datetime
JOIN date_ranges dr
    ON tb_max.tickersymbol = dr.tickersymbol 
    AND tb_max.datetime BETWEEN dr.start_date AND dr.end_date
ORDER BY tb_max.datetime ASC, tb_max.tickersymbol ASC;
"""

# Data for each mins
matched_data_query="""
WITH date_ranges AS (
    SELECT 'VN30F2101' AS tickersymbol, '2021-01-04'::DATE AS start_date, '2021-01-14'::DATE AS end_date UNION ALL
    SELECT 'VN30F2102', '2021-01-15'::DATE, '2021-02-18'::DATE UNION ALL
    SELECT 'VN30F2103', '2021-02-19'::DATE, '2021-03-18'::DATE UNION ALL
    SELECT 'VN30F2104', '2021-03-19'::DATE, '2021-04-15'::DATE UNION ALL
    SELECT 'VN30F2105', '2021-04-16'::DATE, '2021-05-20'::DATE UNION ALL
    SELECT 'VN30F2106', '2021-05-21'::DATE, '2021-06-17'::DATE UNION ALL
    SELECT 'VN30F2107', '2021-06-18'::DATE, '2021-07-15'::DATE UNION ALL
    SELECT 'VN30F2108', '2021-07-16'::DATE, '2021-08-19'::DATE UNION ALL
    SELECT 'VN30F2109', '2021-08-20'::DATE, '2021-09-16'::DATE UNION ALL
    SELECT 'VN30F2110', '2021-09-17'::DATE, '2021-10-21'::DATE UNION ALL
    SELECT 'VN30F2111', '2021-10-22'::DATE, '2021-11-18'::DATE UNION ALL
    SELECT 'VN30F2112', '2021-11-19'::DATE, '2021-12-16'::DATE UNION ALL
    SELECT 'VN30F2201', '2021-12-17'::DATE, '2022-01-20'::DATE UNION ALL
    SELECT 'VN30F2202', '2022-01-21'::DATE, '2022-02-17'::DATE UNION ALL
    SELECT 'VN30F2203', '2022-02-18'::DATE, '2022-03-17'::DATE UNION ALL
    SELECT 'VN30F2204', '2022-03-18'::DATE, '2022-04-21'::DATE UNION ALL
    SELECT 'VN30F2205', '2022-04-22'::DATE, '2022-05-19'::DATE UNION ALL
    SELECT 'VN30F2206', '2022-05-20'::DATE, '2022-06-16'::DATE UNION ALL
    SELECT 'VN30F2207', '2022-06-17'::DATE, '2022-07-21'::DATE UNION ALL
    SELECT 'VN30F2208', '2022-07-22'::DATE, '2022-08-18'::DATE UNION ALL
    SELECT 'VN30F2209', '2022-08-19'::DATE, '2022-09-15'::DATE UNION ALL
    SELECT 'VN30F2210', '2022-09-16'::DATE, '2022-10-20'::DATE UNION ALL
    SELECT 'VN30F2211', '2022-10-21'::DATE, '2022-11-17'::DATE UNION ALL
    SELECT 'VN30F2212', '2022-11-18'::DATE, '2022-12-15'::DATE UNION ALL
    SELECT 'VN30F2301', '2022-12-16'::DATE, '2023-01-19'::DATE UNION ALL
    SELECT 'VN30F2302', '2023-01-20'::DATE, '2023-02-16'::DATE UNION ALL
    SELECT 'VN30F2303', '2023-02-17'::DATE, '2023-03-16'::DATE UNION ALL
    SELECT 'VN30F2304', '2023-03-17'::DATE, '2023-04-20'::DATE UNION ALL
    SELECT 'VN30F2305', '2023-04-21'::DATE, '2023-05-18'::DATE UNION ALL
    SELECT 'VN30F2306', '2023-05-19'::DATE, '2023-06-15'::DATE UNION ALL
    SELECT 'VN30F2307', '2023-06-16'::DATE, '2023-07-20'::DATE UNION ALL
    SELECT 'VN30F2308', '2023-07-21'::DATE, '2023-08-17'::DATE UNION ALL
    SELECT 'VN30F2309', '2023-08-18'::DATE, '2023-09-21'::DATE UNION ALL
    SELECT 'VN30F2310', '2023-09-22'::DATE, '2023-10-19'::DATE UNION ALL
    SELECT 'VN30F2311', '2023-10-20'::DATE, '2023-11-16'::DATE UNION ALL
    SELECT 'VN30F2312', '2023-11-17'::DATE, '2023-12-21'::DATE UNION ALL
    SELECT 'VN30F2401', '2023-12-22'::DATE, '2024-01-18'::DATE UNION ALL
    SELECT 'VN30F2402', '2024-01-19'::DATE, '2024-02-15'::DATE UNION ALL
    SELECT 'VN30F2403', '2024-02-16'::DATE, '2024-03-21'::DATE UNION ALL
    SELECT 'VN30F2404', '2024-03-22'::DATE, '2024-04-18'::DATE UNION ALL
    SELECT 'VN30F2405', '2024-04-19'::DATE, '2024-05-16'::DATE UNION ALL
    SELECT 'VN30F2406', '2024-05-17'::DATE, '2024-06-20'::DATE UNION ALL
    SELECT 'VN30F2407', '2024-06-21'::DATE, '2024-07-18'::DATE UNION ALL
    SELECT 'VN30F2408', '2024-07-19'::DATE, '2024-08-15'::DATE UNION ALL
    SELECT 'VN30F2409', '2024-08-16'::DATE, '2024-09-19'::DATE UNION ALL
    SELECT 'VN30F2410', '2024-09-20'::DATE, '2024-10-17'::DATE UNION ALL
    SELECT 'VN30F2411', '2024-10-18'::DATE, '2024-11-21'::DATE UNION ALL
    SELECT 'VN30F2412', '2024-11-22'::DATE, '2024-12-19'::DATE UNION ALL
    SELECT 'VN30F2501', '2024-12-20'::DATE, '2025-01-16'::DATE UNION ALL
    SELECT 'VN30F2502', '2025-01-17'::DATE, '2025-02-20'::DATE UNION ALL
    SELECT 'VN30F2503', '2025-02-21'::DATE, '2025-03-20'::DATE
)
, trade_data AS (
    SELECT 
        DATE_TRUNC('minute', m.datetime) AS datetime,
        DATE(m.datetime) AS date,
        m.tickersymbol AS symbol,
        MIN(m.price) AS min,
        MAX(m.price) AS max,
        FIRST_VALUE(m.price) OVER (PARTITION BY DATE_TRUNC('minute', m.datetime), m.tickersymbol ORDER BY m.datetime) AS raw_open,
        LAST_VALUE(m.price) OVER (PARTITION BY DATE_TRUNC('minute', m.datetime), m.tickersymbol ORDER BY m.datetime RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS close
    FROM quote.matched m
    JOIN date_ranges dr 
        ON m.tickersymbol = dr.tickersymbol 
        AND DATE(m.datetime) BETWEEN dr.start_date AND dr.end_date
    GROUP BY datetime, date, symbol
)
, final_data AS (
    SELECT 
        datetime,
        symbol,
        max,
        min,
        close,
        -- If it is the first minute of the day, use raw_open; otherwise, use the previous minute's close
        CASE 
            WHEN datetime = MIN(datetime) OVER (PARTITION BY date, symbol) THEN raw_open
            ELSE LAG(close) OVER (PARTITION BY date, symbol ORDER BY datetime)
        END AS open
    FROM trade_data
)
SELECT DISTINCT ON (datetime, symbol) datetime, symbol, max, min, close, open 
FROM final_data
ORDER BY datetime ASC, symbol ASC;

"""
